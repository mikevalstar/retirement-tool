generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model Todo {
  id        Int      @id @default(autoincrement())
  title     String
  createdAt DateTime @default(now())
}

model Person {
  id        Int       @id @default(autoincrement())
  name      String
  birthYear     Int?  // 4-digit year, optional (used for glide path recommendations)
  retirementAge Int?  // target retirement age, optional (used for projection chart markers)
  // Pension projection fields
  oasResidenceYears Int? // Years of Canadian residence after age 18 (for OAS calculation). Default assumption = 40 for full pension.
  pensionClaimAge   Int? // Age at which to claim CPP/OAS. Default 65 for projections.
  sortOrder     Int   @default(0)
  createdAt DateTime  @default(now())
  // Restrict (Prisma default) — cannot delete a Person who owns accounts.
  // This prevents accidentally nuking investment history via Settings.
  accounts      Account[]
  incomeSources IncomeSource[]
}

// ─── Account Types ────────────────────────────────────────────────────────────
// Fixed set of Canadian registered and non-registered account types.
// Prisma maps enums to strings in SQLite. CHEQUING and REGULAR_SAVINGS are
// cash/savings accounts — they do not track investment returns (enforced in UI).

enum AccountType {
  TFSA            // Tax-Free Savings Account — registered, tax-sheltered growth
  RRSP            // Registered Retirement Savings Plan — pre-tax contributions, taxed on withdrawal
  RRIF            // Registered Retirement Income Fund — converted from RRSP, mandatory annual drawdowns
  REGULAR_SAVINGS // Non-registered savings — no tax advantages, no contribution limits
  CHEQUING        // Chequing / cash account — liquidity tracking only, no return history
}

enum IncomeFrequency {
  ANNUAL  // Annual income amount
  MONTHLY // Monthly income amount (displayed as annual equivalent: × 12)
}

// ─── Investment Accounts ──────────────────────────────────────────────────────

model Account {
  id        Int         @id @default(autoincrement())
  name      String      // User-defined label (e.g. "TD TFSA", "Mike's RRSP")
  type      AccountType
  // FK to Person — no shared accounts. If an account is technically joint,
  // the user picks a primary owner. Deleting a Person is blocked if they own accounts.
  ownerId   Int
  owner     Person      @relation(fields: [ownerId], references: [id])
  createdAt DateTime    @default(now())

  // Target asset allocation — null means not yet configured.
  // All three should sum to 100 when set. CHEQUING accounts are excluded from allocation UI.
  equityPct      Float?
  fixedIncomePct Float?
  cashPct        Float?

  snapshots BalanceSnapshot[]
  returns   ReturnEntry[]
}

// ─── Balance Snapshots ────────────────────────────────────────────────────────
// Point-in-time balance records. Not editable — delete and re-add to correct.
// "Current balance" = the snapshot with the most recent `date`, not `createdAt`.
// Retroactive entries are allowed; ordering is always by `date`.

model BalanceSnapshot {
  id        Int      @id @default(autoincrement())
  accountId Int
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  // The as-of date for this balance reading — this is what determines "current".
  // Two snapshots on the same date are allowed (e.g. mid-month vs end-of-month).
  date      DateTime
  balance   Float    // CAD amount
  note      String?  // Optional memo (e.g. "after Q4 dividend reinvestment")
  // Insertion timestamp — for audit only. Do not use for balance ordering; use `date`.
  createdAt DateTime @default(now())
}

// ─── Annual Returns ───────────────────────────────────────────────────────────
// One return percentage per account per year. Not editable — delete and re-add.
// Hidden in the UI for CHEQUING and REGULAR_SAVINGS account types.

model ReturnEntry {
  id            Int      @id @default(autoincrement())
  accountId     Int
  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  year          Int      // Calendar year (e.g. 2024)
  // Stored as a plain percentage value: 7.5 means 7.5%, -12.3 means a down year.
  // Formula from the inline calculator: (end - start - netContributions) / start * 100
  returnPercent Float
  createdAt     DateTime @default(now())

  // One return entry per account per year. Delete the existing row before re-adding
  // to correct a mistake — the UI enforces this with delete-only rows.
  @@unique([accountId, year])
}

// ─── Glide Path ───────────────────────────────────────────────────────────────
// Portfolio-wide target allocation waypoints over time. One record per calendar
// year. The simulation interpolates linearly between waypoints to model how
// portfolio returns should shift year by year as the user de-risks.

model GlidePathWaypoint {
  id             Int      @id @default(autoincrement())
  year           Int      @unique // One waypoint per calendar year
  equityPct      Float
  fixedIncomePct Float
  cashPct        Float
  createdAt      DateTime @default(now())
}

// ─── Income Sources ────────────────────────────────────────────────────────────
// Employment income tracking. Each source belongs to one person.
// Simple model: name + amount + frequency. No start/end dates — represents
// current active income only. Career changes are handled by editing or replacing.

model IncomeSource {
  id        Int             @id @default(autoincrement())
  name      String          // e.g. "Software Engineer", "Consulting"
  ownerId   Int
  owner     Person          @relation(fields: [ownerId], references: [id])
  amount    Float           // CAD amount as entered
  frequency IncomeFrequency // ANNUAL or MONTHLY
  sortOrder Int             @default(0)
  createdAt DateTime        @default(now())
}

// ─── Properties (Housing) ───────────────────────────────────────────────────────
// Real estate properties with mortgage details. Simple model: name, estimated value,
// mortgage balance, mortgage rate. No owner assignment — properties are standalone.
// Used for net worth tracking in retirement projections.

model Property {
  id              Int      @id @default(autoincrement())
  name            String   // e.g. "Primary Residence", "Cottage"
  estimatedValue  Float    // Current market value estimate (CAD)
  mortgageBalance Float    // Remaining mortgage principal (CAD)
  mortgageRate    Float?   // Annual interest rate (e.g., 5.25). Nullable for paid-off properties.
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now())
}