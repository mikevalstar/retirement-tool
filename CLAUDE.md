# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

---

## Attribution

All commits, PR descriptions, and GitHub issue comments created by Claude must include a co-author line:

```
Co-Authored-By: Claude <noreply@anthropic.com>
```

---

## Collaboration Philosophy

This is a collaborative project — treat the developer as a peer, not a client. Push back when something is a bad idea, suggest better approaches, and be direct. We're building this together.

**Key principles:**
- **Lean on libraries.** Don't reinvent what a library already does well. This is about delivering functionality, not owning every inch of the implementation.
- **Audience of one.** This tool is for the developer personally. Don't add guard rails, warnings, or validation for edge cases that won't happen in real use. Let the user do dumb things if they want to.
- **Simplicity first.** Most of this app is CRUD. Treat it that way. Avoid abstractions that don't earn their complexity.
- **AI sparingly, impactfully.** AI features are reserved for high-value moments (e.g., auto-categorizing merchants from credit card imports) — not sprinkled everywhere.
- **Code structured for AI collaboration.** Keep modules focused, types explicit, and avoid deeply nested logic that's hard to read in a single context window.

---

## Shell / Environment Notes

- **Always use absolute paths with `cd`.** The shell has zoxide installed which intercepts `cd` and breaks on multi-segment relative paths (e.g. `cd retirement-planner/src` fails). Use full absolute paths instead: `cd /Users/mikevalstar/projects/retirement-tool/retirement-planner`.

---

## Commands

All commands run from `retirement-planner/`:

```bash
pnpm dev          # Start dev server (port 3000)
pnpm build        # Production build
pnpm test         # Run tests (Vitest)
pnpm lint         # Biome lint
pnpm format       # Biome format
pnpm format:fix   # Biome format with auto fix
pnpm check        # Biome lint + format check (run this to catch issues)
```

**Type-check** (no dedicated script — use tsc directly):
```bash
cd /Users/mikevalstar/projects/retirement-tool/retirement-planner && npx tsc --noEmit
```

**Database:**
```bash
pnpm db:generate  # Regenerate Prisma client after schema changes
pnpm db:push      # Push schema to SQLite without a migration (dev shortcut)
pnpm db:migrate   # Create and apply a named migration
pnpm db:studio    # Open Prisma Studio (visual DB browser)
pnpm db:seed      # Run seed script (prisma/seed.ts)
```

Env vars are loaded from `.env.local` for all `db:*` commands.

**Add a shadcn component:**
```bash
pnpm dlx shadcn@latest add <component>
```

---

## TanStack Reference

Full TanStack library documentation index (for LLM context): https://tanstack.com/llms.txt

Key docs used in this project:
- https://tanstack.com/start/latest/docs/framework/react/overview — TanStack Start (SSR, createServerFn, loaders)
- https://tanstack.com/router — TanStack Router (file-based routing, type-safe params)
- https://tanstack.com/form — TanStack Form (useForm, useField, Zod integration)
- https://tanstack.com/store/latest/docs/overview — TanStack Store (reactive state)
- https://tanstack.com/ai/latest/docs/getting-started/overview — TanStack AI (adapters, streaming, tools)

---

## Architecture

### Stack

| Layer | Technology |
|---|---|
| Framework | TanStack Start (SSR/SPA hybrid) |
| Router | TanStack Router (file-based) |
| State | TanStack Store + Jotai (lightweight) |
| Data | Prisma + better-sqlite3 (local SQLite only) |
| Forms | TanStack Form + Zod |
| Styling | Tailwind CSS v4 + design tokens in `styles.css` |
| Linting/Formatting | Biome |
| Testing | Vitest + Testing Library |
| AI | TanStack AI (Anthropic/Gemini/OpenAI adapters available) |

### Directory layout

```
retirement-planner/
  prisma/               # Prisma schema, migrations, seed
  src/
    components/         # Shared UI components
      ui/               # shadcn primitives
      AppShell.tsx      # 3-zone layout (sidebar + topbar + main)
      Sidebar.tsx       # Collapsible nav with section accordion
      TopBar.tsx        # Breadcrumb + Ctrl+K stub + Run Simulation
    routes/             # File-based routes (TanStack Router)
      __root.tsx        # Root layout shell, loads AppShell
      index.tsx         # Dashboard (/)
      investments/      # /investments/*
      expenses/         # /expenses/*
      demo/             # Starter demo files — safe to delete eventually
    lib/                # Pure utilities (site config, shared helpers)
    hooks/              # React hooks
    data/               # Static/reference data
    db.ts               # Singleton Prisma client
    styles.css          # Design tokens + Tailwind config (do not run Biome on this file)
    routeTree.gen.ts    # Auto-generated by TanStack Router — never edit manually
  docs/plan/            # Planning docs and UI spec (reference, not code)
```

### Routing

TanStack Router with file-based routing. Adding a file to `src/routes/` auto-registers the route. The generated route tree is at `src/routeTree.gen.ts` — regenerated on dev server start or build.

Use `Route.useLoaderData()` to access data loaded by a route's `loader`. For server-only code use `createServerFn`.

For routes that exist in the sidebar but aren't built yet, the only acceptable `as any` cast in this codebase is on unregistered `to` props: `to={"/unbuilt-path" as any}`. Add a `// TODO: remove cast when route is registered` comment inline.

### Database

Single SQLite file via Prisma + `@prisma/adapter-better-sqlite3`. The client singleton lives in `src/db.ts`. After any schema change:

1. Edit `prisma/schema.prisma`
2. `pnpm db:migrate` (or `db:push` for quick dev iteration)
3. `pnpm db:generate` to regenerate the Prisma client

### Design System

Dark-only. Design tokens are CSS custom properties defined in `src/styles.css`.

**Section colors** — each app domain has its own accent, used consistently in sidebar indicators, section headers, and charts:

```
--section-dashboard:   #06b6d4  (cyan)
--section-investments: #10b981  (green)
--section-income:      #14b8a6  (teal)
--section-expenses:    #f59e0b  (amber)
--section-housing:     #6366f1  (indigo)
--section-taxes:       #f97316  (coral/orange)
--section-scenarios:   #8b5cf6  (violet)
--section-simulation:  #00e5ff  (bright cyan)
```

**Typography:**
- Body: IBM Plex Sans
- Numbers: JetBrains Mono — apply the `.num` CSS class to any financial figure for monospace tabular rendering

**Surface hierarchy:** `--app-bg` → `--sidebar-bg` → `--surface` → `--surface-raised`

**Layout shell:** Sidebar (220px expanded / 52px collapsed, persisted in `localStorage`), TopBar (44px), scrollable main. Collapse state handled in `AppShell.tsx`.

### Styling approach

- Design tokens (CSS vars) for colors, surfaces, borders — prefer these over raw Tailwind color classes
- **Never hardcode hex color values** — always use the corresponding CSS variable (e.g. `var(--section-investments)` not `#10b981`). This applies to inline styles, style objects, and className strings.
- Tailwind utilities are fine for spacing, layout, flex/grid
- Inline `style` objects are acceptable for one-off structural styles tied to component logic
- `color-mix()` is available and used for tinted backgrounds (e.g., icon well backgrounds)

### Code Quality Rules

- **No `as any` except unbuilt routes.** `as any` is only sanctioned for unregistered TanStack Router `to` props. Every other `as any` or explicit `: any` type annotation is a bug — fix the types properly.
- **No `@ts-ignore` / `@ts-expect-error`** unless paired with a comment explaining why it's unavoidable and a link to an upstream bug.
- **Wrap all `createServerFn` calls in try/catch.** Surface errors to the user — don't silently swallow failures or leave UI in a broken loading state.
- **Validate server function inputs with Zod.** Every `createServerFn` with user-supplied data should use a Zod schema in `.inputValidator()`, not a plain TypeScript cast.
- **Prefer named types over inline object types** in function signatures — keeps function signatures readable at a glance.

### Code Committing
Before committing code run a `format:fix` and `check` to keep things consistent.

### AI integration

AI is used sparingly — the primary planned use is merchant categorization in the expense import flow. TanStack AI is already installed with adapters for Anthropic, Gemini, OpenAI, and Ollama. The Anthropic API key goes in `.env.local` as `ANTHROPIC_API_KEY`.

---

## What's built vs. placeholder

| Section | Status |
|---|---|
| Dashboard | Built (static/empty state) |
| Investments | Route stub exists |
| Expenses | Route stub exists |
| Everything else | Not yet created |
| `demo/`, `blog`, `about` routes | Starter boilerplate — not removed yet, not part of the app |

The demo components (`demo-*` files in `src/components/`) and demo routes in `src/routes/demo/` are leftover scaffolding. Don't touch them; they'll be cleaned up later.
